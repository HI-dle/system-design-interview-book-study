# 알림 시스템 상세 설계

---

- 개략적으로 설계를 진행하며 알림의 종류, 연락처 정보 수집 절차, 알림 전송, 수신 절차에 대해 살펴보았고 이후 안정성, 추가로 필요한 컴포넌트 및 고려사항인 알림 템플릿, 알림 설정, 전송률 제한, 재시도 메커니즘, 보안, 큐에 보관된 알림에 대한 모니터링과 이벤트 추적, 개선된 설계안에 대해 알아보아야 한다.



## 안정성
 - 분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 반드시 고려해야 한다.



## 데이터 손실 방지
 - 알림 전송 시스템의 가장 중요한 요구사항 중 하나는 알림이 소실되면 안 된다는 것이다. 알림이 지연되거나 순서가 틀려도 괜찮지만 사라지면 곤란하다는 것으로 요구사항을 만족하려면 알림 시스템은 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다. 알림 로그 데이터베이스를 유지하는 것이 한 가지 방법이다.

![image_10-11.png](image%2Fimage_10-11.png)


## 알림 중복 전송 방지
 - 같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 가능하지 않다. 
 - 대부분의 경우 알림은 딱 한 번만 전송되겠지만 분산 시스템의 특성상 가끔은 같은 알림이 중복되어할 것이다. 
 - 그 빈도를 줄이려면 중복을 탐지하는 메커니즘을 도입하고 오류를 신중히 처리해야 한다. 
 - 중복 방지 로직으로는 보내야 할 알림이 도착하면 그 이벤트 ID를 검사해 이전에 본 적 있는 이벤트인지 살핀 후 중복된 이벤트라면 버리고 그렇지 않다면 알림을 발송하는 로직이 필요하다.

 - 책의 내용으로는 중복 전송을 100% 방지하는 것은 불가능하다는데 이유를 알아보자.
---

 - 처음 이해하기를 알림에 대한 내용을 전송할 때 중복 전송을 방지할 수 없다고 이해했지만 책에서 참고하는 자료의 내용을 확인하고는 중복 전송 방지에 대한 말이 다르단 것을 확인했다.

 - 위에서 설명한 100% 중복 전송 방지가 불가하단 말은 분산 시스템 안에서 정확히 한 번만 메시지를 전달하는 것은 불가하다는 것이다.

 - 웹 브라우저와 서버, 서버와 DB, 서버와 메시지 큐 에서의 분산을 생각하면 이때 정확히 한 번만 메시지를 전달하는 의미 체계를 가질 수 없다.

 - 분산 시스템은 모두 상충 관계에 관한 것으로 기본적으로 한 번, 최소 한 번 및 정확히 한 번의 세가지 유형이 있고 기본적, 최소 한 번은 실행이 가능하고 널리 사용된다. 네트워크 연결에서 서버로의 연결이 무기한 중단 된다면 아무것도 전달할 수 없다는 것이다.

 - 이때 FLP라는 개념이 나온다.

 - FLP란 비동기 분산 시스템에서 단 하나의 노드라도 고장날 가능성이 있다면 합의(Consensus)는 보장할 수 없다는 것으로 3가지의 전제가 필요하다. 비동기 시스템이어야 한다. 노드 고장 가능성이 있다. 분산 합의가 필요하다(모든 노드가 같은 값을 결정해야 하는 것).

 - 이 FLP를 통해 기본적으로 프로세스에 오류가 있다는 가능성을 고려하고 따라서 수신 확인(ACK)을 무한 반복해도 서로 메시지를 받았다는 사실은 확신할 수 없다.

| 전달 방식             | 설명                                                  | 문제점               |
| ----------------- | --------------------------------------------------- | ----------------- |
| **At-most-once**  | 메시지를 한 번만 보냄. 실패하면 끝.                               | 데이터 손실 위험         |
| **At-least-once** | 메시지를 재전송함. 중복 가능성 있음.                               | 중복 처리 필요          |
| **Exactly-once**  | 이론상 불가능. 구현 시 사실상 **idempotent 처리 + deduplication** | "가짜 exactly-once" |


 - 다음과 같은 전달 방식에서 FLP 이론으로 비동기 분산 시스템에서는 하나의 프로세스가 실패할 수 있다면 합의는 보장될 수 없다는 불가능성 증명과 Two Generals Problem / Byzantine(비잔틴) Generals Problem은 수신자와 송신자가 정확하게 동기화되어 있다는 확신을 가질 수 없다.

 - 한 번만 처리되었는지 확인하기 위한 ack조차 실패 가능성이 있기 때문이다.

 - 그러므로 현실에서 가능한 방식은 2가지 라는 것이다.

   - At-most-once: 중복 없음, 손실 가능성 존재.

   - At-least-once: 손실 없음, 중복 가능성 존재.

   - Exactly-once는 마케팅 용어일 뿐 실질적으로는 idempotency나 deduplication을 통해 흉내내는 것에 불과하다.



 - Kafka의 Exactly-once 역시 producer + consumer + storage 전 구간을 제어하며 결국 idempotent 한 설계를 요구한다.

 - RabbitMQ도 공식 문서에서 확인(ack)을 못 받으면 중복 전송 가능하므로 클라이언트 측 중복 처리 필요라고 명시했다.

 - 즉, 메시지를 딱 한 번만 처리했는지 확인하려면 모든 참여 노드가 처리 여부에 대한 일치된 상태를 가져야 한다.

 - 하지만 FLP 정리에 따르면 네트워크가 비동기이고, 노드가 실패할 수 있다면 한 번만 처리됨이라는 합의 자체를 보장할 수 없습니다.

 - 그래서 결국 Exactly-once는 이론적으로 불가능하다. 현실에서는 중복 가능성을 인정하고, 멱등성(idempotency)으로 대응한다.

 - Kafka, RabbitMQ, AWS 등 대부분의 메시징 시스템은 at-least-once만 제공하며, Exactly-once를 제공한다고 주장하는 경우는 내부적으로는 at-least-once + idempotency 처리이다.

 - 이외로 주문형 메시지 처리보다 상태(State) 자체를 전달하는 모델이 더 견고하다고 설명하는 부분이 있다. 이 부분이 이해가 어려웠기에 더 알아보면 다음과 같다.

 - 방향을 반복 전달보다 위치를 전달하는 식으로 사고 전환이다.

 - 이는 분산 시스템에서 멱등성과 중복 메시지 처리의 사고방식 전환을 설명한다.

>방향을 반복 전달하는 방식이란 제가 진영님에게 길을 알려 드리는데 한 블록 가서 좌회전 하시고 다음 블록에서 우회전하시면 됩니다.라는 동작을 반복적으로 전송한다 가정했을 때 "한 블록 가", "좌회전", "다음 블록까지 가", "우회전" 이 메시지가 중복이라면 문제가 발생한다는 것이다. 한 블록 가 메시지가 중복으로 3번 전송된다면 3블록을 가버리기 때문에 중복 메시지는 상태를 왜곡시킨다.
반면 위치를 전달하는 방식은 진영님 저 야우리에 있어요~ 하면 진영님이 중복으로 메시지를 받는다 하더라도 어딘지 알고 오시면 되기 때문에 결과에 영향이 없습니다. 위치와 방향이라는 개념으로 소개가 되어 있어서 와닿지 않았지만 이처럼 멱등을 지키는 설계가 필요하단 것입니다.
 
 -  위에서 설명한 개념들에 이어 정리하자면 네트워크나 분산 환경에서 각 노드들 환경에 따라 절대적으로 완전한 시스템은 없기에 비동기 메시지 처리에서 완전히 단 한 번의 처리를 보장하는 것은 불가하다는 것과 결국 최소 한 번을 보장하고 멱등하게 구성하여 완전히 한 번처럼 보장하는 것처럼 보이게 하는 것이다.

---

## 추가로 필요한 컴포넌트 및 고려사항

 - 지금까진 연락처 정보를 어떻게 수집하고 알림은 어떻게 보내고 받을 것인지 살펴보았고 알림 시스템 구현에 필요한 추가 컴포넌트를 알아보아야 한다.

 - 알림 서비스에는 알림 템플릿, 알림 설정, 이벤트 추적, 시스템 모니터링, 처리율 제한 등이 필요하다.
   - 알림 템플릿은 대형 알림 시스템은 하루에도 수백만 건 이상의 알림을 처리하는데 이때 처리 되는 알림의 형식은 비슷하거나 규격화되어있다. 유사성을 고려해 알림 템플릿은 파라미터나 스타일, 추적 링크를 조정해서 사전에 맞춘 틀에 적용해 보내는 방식이다. 
     - 최근 직접 구현한 알림 서비스의 템플릿도 전략 패턴을 통해 유형을 전달받고 객체 내부의 사용자 이름, 식당 이름, 시간 등 변동 데이터만 파라미터로 넣고 규격화해 전송하도록 구성했었다.
   - 알림 설정은 사용자는 이미 많은 알림을 받고 있을 것이다. 이에 따라 알림 설정을 상세히 조절할 수 있도록 해야 한다. 이 정보는 테이블에 보관되고 테이블 필드를 추가해 알림이 전송될 채널에 대한 선택, 해당 채널로 알림을 받을지 여부에 해당하는 데이터를 저장해 이 설정 값에 따라 알림을 전송해야 한다.

   - 전송률 제한은 너무 많은 알림을 보내지 않게 하기 위한 것으로 한 사용자가 받을 수 있는 알림의 빈도를 제한하는 것이다. 이는 사용자 경험에 포함되고 너무 많은 알림은 사용자에게 불쾌감을 주고 알림을 꺼두게 되며 서비스에 영향이 갈 수 있게 된다.

   - 재시도 방법은 제3자 서비스가 알림 전송에 실패하면 해당 알림을 재시도 전용 큐 에 넣는다. 같은 문제가 지속적으로 발생하면 개발자에게 알림을 발생하게 하는 것이다. 

 - 이외에 푸시 알림과 보안, 큐 모니터링, 이벤트 추적, 수정된 설계안을 통한 컴포넌트와 고려 사항이 있지만 지은님이 저보다 훨~~~~~~~~~씬 잘 해주실겁니다.

---

## 질문
 - 중복 전송에서 100% 방지가 왜 불가능한지 알고 싶습니다..
---

## 답변
 - 위에서 설명을 했는데...답변이 되었을까요? 궁금한 점 더 있다면 말씀 해주십셔