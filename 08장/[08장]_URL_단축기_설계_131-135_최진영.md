# URL 단축기 설계

---

## 개략적 설계안(앞선 발표에 이은)
### URL 단축
해시 함수는 다음과 같은 조건을 만족해야합니다.
- 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 한다.
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

아래 내용부터는 데이터 모델, 해시 함수, URL 단축 및 리다이렉션에 관한 보다 구체적인 설계안을 만들어 보겠습니다.

---
## 3단계 상세 설계
### 데이터 모델
이전 내용에서 개략적 설계를 진행할 때는 해시 테이블에 `<단축 URL, 원래 URL>` 과 같이 저장했었습니다.

이 접근법은 초기 전략으로는 괜찮지만 실제 시스템에서는 쓰기가 곤란한데, 메모리는 유한하고, 비싸기 때문입니다.

따라서 더 나은 방법은 `<단축 URL, 원래 URL>` 순서쌍을 RDBMS에 저장하는 것입니다.
![image_8-4.png](image%2Fimage_8-4.png)
> 이 테이블은 단순화된 것으로 실제 테이블은 이것보다 더 많은 컬럼을 가질 수 있습니다. 여기서는 중요한 컬럼만 추렸다고 합니다.

### 해시 함수
`해시 함수(hash function)`은 원래 URL을 단축 URL로 변환하는 데 쓰입니다.

아래부터는 해시 함수를 통해 나온 값인 단축 URL을 'hashValue'라고 편의 상 지칭하겠습니다.

hashValue는 `[0-9, a-z, A-Z]`의 문자들로 구성됩니다. 따라서 사용할 수 있는 문자의 개수는 10 + 26 + 26 = 62개 입니다.

개략적 설계안에서 면접관과의 대화를 통해 매일 1억개의 단축 URL을 생성하며, 10년 동안에는 3650억 개를 생성합니다.

즉, 우리의 시스템은 `3650억개의 중복되지 않는 hashValue`를 만들어 낼 수 있어야 합니다.

아래 표는 hashValue의 길이와, 해시 함수가 만들 수 있는 URL의 개수 사이의 관계를 나타냅니다.
![image_표_8-1.png](image%2Fimage_%ED%91%9C_8-1.png)

우리의 요구사항을 충분히 만족시키는 길이는 '7'임을 알 수 있습니다.

### 해시 함수 구현 방법
다음으로는 해시 함수 구현에 쓰일 기술로 두 가지 방법을 살펴보고자 합니다. 두 가지 방법은 아래와 같습니다.
- 해시 후 충돌 해소
- base-62 변환

#### 해시 후 충돌 해소
일단 현재 요구사항에 맞게 URL을 7글자 문자열로 줄이려면, 그에 맞는 '해시 함수'가 필요합니다. 손쉬운 방법으로는 `CRC32, MD5, SHA-1` 같이 잘 알려진 해시 함수를 이용하는 것입니다.

아래 그림은 책에서 위 3개의 해시 함수를 사용한 예시입니다.
![image_표_8-2.png](image%2Fimage_%ED%91%9C_8-2.png)

가장 짧은 해시값인 `CRC32`가 계산한 결과를 보시면, 우리가 원하는 길이인 7보다는 긴 상황이라 줄여야합니다.

어떻게 줄일 수 있을까요?

첫번째 방법은 `결과의 앞 7글자만 사용` 하는 것입니다.
```markdown
[5cb5405]4 -> 5cb5405
[1234567]X
```

하지만 이렇게 되면, 해시 충돌이 발생할 확률이 높아질 것입니다. 충돌이 실제로 발생했을 때는, 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다.
아래는 이 절차를 나타내는 그림입니다.

![image_8-5.png](image%2Fimage_8-5.png)
```markdown
https://hidle.com/users/jinyoung --[해시 함수]--> DB에 있나? -> 예 -> 충돌 발생!

사전에 정해둔 문자열인 "jihoon"을 붙이자.

https://hidle.com/users/jinyoungjihoon --[해시 함수]--> DB에 있나? -> 아니오 -> 저장 후 종료
```

위와 같은 방법을 사용하면 충돌은 해소할 수 있습니다. 하지만, 단축 URL을 생성할 때 `최소 한 번`은 DB에 질의를 해야하므로 오버헤드가 큽니다.

그래서 데이터베이스 대신 블룸 필터를 사용하면 성능을 높일 수 있습니다.
> DB 대신 블룸 필터를 사용한다는건, DB를 조회하기 전에 블룸 필터로 DB에 중복된 해시값이 없는 지를 빠르게 파악한다는 것으로 이해했습니다.
> 
> 잠깐 블룸 필터를 복습하자면, 블룸 필터는 스토리지에 찾고자하는 데이터가 `없음`은 확실하게 알 수 있지만, `있음`은 확정하지 못하는 특징이 있습니다.

#### base-62 변환
진법 변환은 URL 단축기를 구현할 때 흔히 사용되는 접근법 중 하나입니다. 그 중에서도 62진법을 사용하는 이유는 'hashValue'에 사용될 수 있는 문자의 개수가 62개이기 때문입니다.

아래는 base-62 변환을 사용하여 해시 함수를 구현하는 과정을 제 생각을 담아 적어보았습니다.
> ❗️책에는 단순히 11157이라는 10진수를 62진법으로 변환하는 과정만 적혀있기에, 저의 생각이 조금 포함되었다는 것을 다시 한번 말씀드립니다..

줄일 URL: `https://hidle.com/users/jinyoung`
- 해당 URL의 ID를 가져옵니다.(DB에 줄일 URL을 먼저 저장해서 ID를 가져와야할 듯 합니다.)
- ID를 62진법으로 변환합니다.(e.g 11157 -> 2TX)
- `https://tinyurl.com/2TX` 가 됩니다.

> 왜 `hidle.com`에서 tinyurl.com으로 도메인이 달라졌냐면, naver 같은 경우도 `naver.com` 대신, `me2.do`와 같은 것을 사용했다고 합니다.

마지막으로 아래는 '해시 후 충돌 해소 전략'과 'base-62 변환'의 차이를 요약한 표입니다.
![image_표_8-3.png](image%2Fimage_%ED%91%9C_8-3.png)

base-62변환에서의 auto-increase 전략에서의 보안 이슈 발생 가능성이나, 충돌이 아예 불가능한 점이 가장 큰 특징인 것 같습니다.
단축 URL에 대해 검색해보니, 빅테크 기업도 해당 보안 문제 탓인지는 모르겠지만, 보안 상 이슈로 단축 URL 서비스를 종료하고 있다고 합니다.



