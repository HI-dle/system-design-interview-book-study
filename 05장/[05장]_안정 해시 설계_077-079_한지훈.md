# 안정 해시 설계

---

## 안정 해시(Consistent Hashing)
 - 수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. 안정 해시는 이목표를 달성하기 위해 보편적으로 사용하는 분산 환경 기술이다.



### 안정 해시 사용의 이유로는 다음과 같다.

 - 트래픽이 특정 서버에 몰리지 않도록 균등한 분산이 필요
 - 서버의 추가/삭제 시 전체 데이터의 재배치가 최소화
 - 안정 해시는 서버의 수가 동적으로 변경되어도 대부분의 요청은 기존 서버로 유지되며, 일부 요청만 이동되도록 설계되어 있어 효율적인 확장이 가능하다.

### 해시키 재배치 문제(rehash)


 - N개의 서버가 있고 아래와 같이 서버에 대한 부하를 균등히 나누었다 가정하자.
````
severIndex = hash(key) % N (N은 서버의 개수)
````
 - 클라이언트에서는 계산된 serverIndex 값을 사용해 데이터에 접근한다.

 - 이런 경우 서버 풀의 개수가 고정이고 데이터 분포가 균등할시 문제점은 생기지 않는다.

![image_5-1.png](image%2Fimage_5-1.png)

![HashTable.png](image%2FHashTable.png)


 - 이렇게 구성시 작동이 잘 되는 해시 키 분배가 가능하다.

 - 하지만 서버가 추가되거나 기존 서버가 삭제될 경우 문제가 발생한다.



 - 4개의 서버가 있는 시스템에서 한 개의 서버가 장애로 인해 동작이 중단될 경우 서버 풀의 크기가 3이 되고 나머지 연산으로 계산한 키 값이 달라지게 된다. 이 경우 기존 연결되어야 할 서버가 아닌 다른 서버에 접속하게 되고 캐시 미스로 이어지게 된다.

 
![image_5-2.png](image%2Fimage_5-2.png)

![HashTableTrouble.png](image%2FHashTableTrouble.png)

 - 장애가 발생한 1번 서버에 보관되어 있는 키 뿐만 아닌 대부분의 키가 재분배되었다.

 - 이 문제를 해결하기 위한 분산 기술로 MIT에서 개발한 안정 해시가 사용된다.



 ## 안정 해시란
 - 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n 개의 키만 재배치하는 해시 기술이다. k는 키의 개수이고 n은 슬롯(slot)의 수이다. 전동 척인 해시 테이블은 슬롯 수가 바뀌면 대부분의 키를 재배치한다.

 - 안정 해시는 해시 공간을 구부린 해시 링이란 개념을 사용하며 해시 공간의 시작과 끝을 이어놓은 구조라 생각하면 되는 개념이다.

---

## 질문

 - 해시 값은 랜덤으로 만들어지지 않나요? 예시에서 8개의 서버가 각 해시 값을 가지고 서버 개수인 4로 나머지 연산을 통해 2개씩 서버에 나뉘게 되었는데 랜덤 값이니 나눈다고 꼭 서버가 2개씩 인덱스를 가질 것 같지 않는데 맞나여?

## 답변

 - 일반적인 해시와 나머지 연산 방식은 서버 수가 고정이고, 해시 함수가 충분히 균등한 분포를 만든다는 가정 하에서만 잘 작동해요.
 - 해시 충돌이나 데이터 쏠림(skew)이 생길 수 있고, 서버 추가/삭제 시 전체 데이터 재해시(hash rebalance)가 필요합니다.
 - 해시에 대해서 친구가
> 해시 함수가 랜덤처럼 보이긴 하지만, 진짜 완전히 랜덤한 건 아니고, 분포가 균등하지 않을 수도 있다는 점
 - 이렇게 설명 해줬고 랜덤처럼 보이는 규칙성 있는 함수로 같은 입력에 대해 항상 같은 출력을 주는 결정적 함수이며, 출력값은 불규칙하게 보이고, 이상적으로는 균등한 분포를 가지도록 설계 됩니다.
 - 균등 분포는 확률적인 것일 뿐이고 보장되지 않음으로 해시 함수의 분포 특성과 키의 패턴에 따라 편향이 생길 수 있습니다.
 - 좋지 않은 해시 함수 (예: String.length()처럼 낮은 변별력)로 해시 사용시 데이터 쏠림 현상이 발생할 수 있고 이에 따라 데이터가 일관 된다는 보장이 없습니다.
 - 그래서 안정 해시 개념이 생기고 사용하는 것 입니다.