# 채팅 시스템 설계

## 상세 설계 - 메시지 흐름
이번 절에서는 아래의 메시지 흐름들을 살펴보고자 합니다.
- 1:1 채팅 메시지 처리 흐름
- 여러 단말 사이의 메시지 동기화
- 소규모 그룹 채팅에서의 메시지 흐름

### 1:1 채팅 메시지 흐름
`사용자 A가 B에게 보낸 메시지가 어떤 경로로 처리` 되는 지 그림으로 살펴보겠습니다.

![image_12-12.png](image%2Fimage_12-12.png)

```markdown
1. 사용자 A가 채팅 서버 1로 메시지 전송
2. 채팅 서버 1은 ID 생성기를 사용해 해당 메시지의 ID를 결정
3. 채팅 서버 1은 해당 메시지를 '메시지 동기화 큐'로 전송
4. 메시지가 '키-값 저장소'에 보관됨
5.a. (B가 접속 중인 경우) 사용자 B가 접속하고 있는 '채팅 서버2'로 메시지 전송
5.b. (B가 미접속인 경우) 메시지를 '푸시 알림 서버'로 전송
6. 채팅 서버2는 사용자 B와 연결 되어 있는 웹소켓을 통해 메시지를 전송
```

### 여러 단말 사이의 메시지 동기화
여러 개의 단말을 사용하는 사람은 많습니다.

아래 그림은 `사용자 A가 전화기와 랩톱 두 대의 단말을 이용`하는 상황입니다. 

![image_12-13.png](image%2Fimage_12-13.png)

1. 사용자의 두 단말 모두 채팅 앱에 로그인 한 결과로 웹소켓 연결이 만들어집니다.
2. 각 단말은 `cur_max_message_id`라는 변수를 유지합니다. 이는 해당 단말에서 `가장 최근에 관측된 메시지의 id`를 의미합니다.

아래 두 조건을 만족하는 `메시지`는 `새 메시지`로 간주됩니다.
- 메시지의 수신자 ID가 로그인한 사용자 ID와 같다.
- 키-값 저장소에 보관된 메시지로서, 그 ID가 `cur_max_message_id`보다 크다.

`cur_max_message_id`는 단말마다 별도로 유지 관리하면 되는 값이라 그 이후에 생긴 메시지만 가져오면 되기 때문에 새 메시지를 가져오는 작업을 쉽게 구현할 수 있습니다.

### 소규모 그룹 채팅에서의 메시지 흐름
1:1 채팅에 비해 그룹 채팅에서의 메시지 흐름은 조금 더 복잡합니다.

아래 그림은 `사용자 A가 그룹 채팅 방에서 메시지를 보냈을 때`를 보여줍니다.(채팅방에는 사용자 A, B, C가 존재합니다.)

![image_12-14.png](image%2Fimage_12-14.png)
1. 사용자 A가 메시지 전송
2. 해당 메시지가 사용자 B와 C의 `메시지 동기화 큐`에 복사됨

> `메시지 동기화 큐`는 사용자 각각의 메시지 수신함이라고 생각하셔도 됩니다.

이 설계안은 `소규모 그룹 채팅`에 적합합니다. 이유는 아래와 같습니다.
- 새로운 메시지가 왔는지 확인하려면 자기 큐만 확인하면 되기 때문에 메시지 동기화 플로우가 간단하다.
- 소규모 그룹에서는 큐에 메시지를 복사하는 작업의 비용이 문제가 되지 않는다.

> 위챗(WeChat)이 이런 접근법을 사용하고 있고, 그룹의 크기는 500명으로 제한하고 있다고 합니다.
> 
> 만약 많은 사용자를 지원해야 하는 경우라면 위와 같이 모든 메시지 동기화 큐에 복사하는 것은 바람직하지 않을 것입니다.

방금까지 설명한 메시지 흐름을 수신자 관점에서도 살펴보겠습니다.

한 수신자는 여러 사용자로부터 오는 메시지를 수신할 수 있어야 합니다. 

따라서 아래 그림처럼 각 사용자의 수신함인 `메시지 동기화 큐`는 여러 사용자로부터 오는 메시지를 받을 수 있어야합니다.

![image_12-15.png](image%2Fimage_12-15.png)